# OPTIMIZED REDIS CONFIGURATION FOR FOG COMPUTING SCHEDULER
# Tuned for: Task scheduling, metrics aggregation, node state tracking
# Features: RediSearch, RedisBloom, RedisJSON, RedisTimeSeries modules


# NETWORK CONFIG
bind 0.0.0.0
port 6379
tcp-backlog 511
timeout 0
tcp-keepalive 300

# GENERAL CONFIG
daemonize no
supervised no
loglevel notice
databases 16

MEMORY MANAGEMENT
# Conservative 640MB limit
maxmemory 640mb

# LRU eviction policy: removes least recently used keys
# Perfect for mixed workload (cache + permanent task state + metrics)
maxmemory-policy allkeys-lru

# Sampling size for LRU algorithm (5 = good accuracy, acceptable CPU)
maxmemory-samples 5

# Enable async freeing to prevent blocking on large evictions
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Memory optimization for large keys
hash-max-listpack-entries 512
hash-max-listpack-value 64
list-max-listpack-size -2
list-compress-depth 0
set-max-intset-entries 512

# PERSISTENCE
# AOF (Append Only File) for durability
# Critical for task state, queue metadata, node assignments
appendonly yes
appendfilename "appendonly.aof"

# Sync every second
# Max 1 second of data loss if server crashes
appendfsync everysec

# Disable RDB snapshots (AOF is sufficient and more durable)
save ""

# AOF file rewrite settings
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
no-appendfsync-on-rewrite no

# Hybrid AOF+RDB format for faster restarts
aof-use-rdb-preamble yes

# Continue loading if AOF is corrupted
aof-load-truncated yes

# PERFORMANCE TUNING
# Multi-threaded I/O for better throughput
# Use 4 threads if manager has 4+ cores, 2 if 2 cores
io-threads 4
io-threads-do-reads yes

# Active defragmentation: consolidates memory fragmentation over time
# Improves memory efficiency without blocking
activedefrag yes
active-defrag-threshold-lower 10
active-defrag-threshold-upper 20
active-defrag-cycle-min 5
active-defrag-cycle-max 75

# Slow query log (track queries > 10ms)
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# Max number of connected clients
# Increase if you have many fog nodes connecting
maxclients 10000

# SECURITY
# Password authentication (set via environment variable in Docker)
requirepass ${REDIS_PASS}

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# CLIENTS
# TCP settings for client connections
# Reduce backlog if connection spikes are a problem
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# MODULES
# Load advanced Redis modules for analytics and search capabilities
loadmodule ./modules/redisbloom/redisbloom.so
loadmodule ./modules/redisearch/redisearch.so
loadmodule ./modules/redisjson/rejson.so
loadmodule ./modules/redistimeseries/redistimeseries.so

# RediSearch CONFIGURATION
# Tuned for your fog scheduler's task/node search queries

# Default SQL-like dialect for ft.search queries
search-default-dialect 1

# Background indexing settings
search-bg-index-sleep-gap 100
search-fork-gc-clean-threshold 100
search-fork-gc-retry-interval 5
search-fork-gc-run-interval 30
search-fork-gc-sleep-before-exit 0
search-gc-scan-size 100

# Query execution settings
search-timeout 500
search-on-timeout fail

# Index cursor management
search-index-cursor-limit 128
search-cursor-max-idle 300000

# Result limits (adjust based on max query result size)
search-max-search-results 1000000
search-max-aggregate-results 2147483648

# Prefix expansion limits (prevents runaway wildcard searches)
search-max-prefix-expansions 200
search-min-prefix 2

# Text processing
search-min-phonetic-term-len 3
search-min-stem-len 4
search-multi-text-slop 100

# Vector similarity search (for advanced ML features)
search-tiered-hnsw-buffer-limit 1024
search-vss-max-resize 0

# Worker threads for parallel processing
# Set to number of CPU cores (2-4 for typical managers)
search-workers 4
search-min-operation-workers 4
search-workers-priority-bias-threshold 1

# Thread pool
search-threads 20

# Advanced options (mostly for tuning)
search-_numeric-ranges-parents 0
search-_free-resource-on-thread yes
search-_numeric-compress no
search-_print-profile-clock yes
search-_prioritize-intersect-union-children no

# Memory management
search-no-mem-pools no
search-no-gc no

# Optimization flags
search-partial-indexed-docs no
search-raw-docid-encoding no

# Topology validation (cluster mode)
search-topology-validation-timeout 30000

# RedisTimeSeries CONFIGURATION
# For collecting fog node metrics, task timing, resource usage over time

# Thread count for cross-key queries (MGET, MRANGE, etc.)
# Don't exceed number of CPU cores
ts-num-threads 3

# Data encoding: COMPRESSED (default) saves space, UNCOMPRESSED is faster
ts-encoding COMPRESSED

# Default retention (0 = unlimited, set per time series if needed)
ts-retention-policy 0

# Duplicate policy: how to handle multiple samples with same timestamp
# LAST = keep newest, FIRST = keep oldest, BLOCK = reject duplicates
ts-duplicate-policy LAST

# Chunk size: balance between memory efficiency and query performance
# Default 4096 bytes is good; increase if you have large metric samples
ts-chunk-size-bytes 4096

# Automatic compaction of old time series (optional)
# Example: "10s:avg 1m:max 1h:sum" creates hourly/minutely summaries
# Uncomment and customize based on your retention policy
# ts-compaction-policy ""

# Ignore near-duplicate samples (reduces storage for noisy sensors)
# Only works with DUPLICATE_POLICY LAST
ts-ignore-max-time-diff 0
ts-ignore-max-val-diff 0

# RedisBloom CONFIGURATION
# For fast membership testing, duplicate detection, cardinality estimation

# Bloom filter defaults
bf-error-rate 0.01              # 1% false positive rate
bf-initial-size 100             # Initial capacity
bf-expansion-factor 2           # Growth factor when full

# Cuckoo filter defaults
cf-initial-size 1024            # Initial capacity
cf-bucket-size 2                # Items per bucket
cf-max-iterations 20            # Rehash attempts before expanding
cf-expansion-factor 1           # Growth factor
cf-max-expansions 32            # Max number of expansions

# ADVANCED OPTIONS
# Stop writes if disk space critical
stop-writes-on-bgsave-error yes

# RDB compression (if using RDB)
rdbcompression yes

# Check CRC64 on RDB load
rdb-checksum yes

# Notify keyspace events
notify-keyspace-events ""

# Hash slot migration settings
cluster-node-timeout 15000

# Append only rewrite randomization
aof-rewrite-incremental-fsync yes

# LOGGING & MONITORING
# Enable command tracing for debugging (disable in production)
loglevel debug

# Latency samples (for latency analysis)
latency-samples 15

# Module info exposure
always-show-logo no
